name: 🔒 Hybrid Security Pipeline

on:
  push:
    branches: [ "main", "master", "develop" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  issues: write
  id-token: write

env:
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  STAGING_URL: ${{ vars.STAGING_URL || 'https://testphp.vulnweb.com' }}
  DEV_URL: ${{ vars.DEV_URL || 'https://juice-shop.herokuapp.com' }}
  PROD_URL: ${{ vars.PRODUCTION_URL || 'https://demo.testfire.net' }}
  MAX_SCAN_TIME: '1800'
  CRITICAL_THRESHOLD: '0'
  HIGH_THRESHOLD: '5'
  MEDIUM_THRESHOLD: '20'
  REPORT_RETENTION_DAYS: '180'

jobs:

  semgrep_static_analysis:
    name: 📝 Semgrep Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Semgrep CLI
        run: pip install semgrep

      - name: Run Semgrep scan with modern CLI syntax
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🔍 Running Semgrep scan..."
          semgrep --config=auto --sarif --quiet > semgrep.sarif || echo "⚠️ SARIF failed"
          semgrep --config=auto --json --quiet > semgrep.json || echo "⚠️ JSON failed"

          if [ -n "$SEMGREP_APP_TOKEN" ]; then
            echo "📤 Uploading to Semgrep Cloud..."
            semgrep ci --config=auto || echo "⚠️ Cloud upload failed"
          fi

      - name: Ensure valid outputs
        run: |
          [ ! -s semgrep.sarif ] && echo '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"semgrep"}},"results":[]}]}'> semgrep.sarif
          [ ! -s semgrep.json ] && echo '{"results":[],"errors":[],"paths":{"scanned":[]}}' > semgrep.json

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep-static

      - name: Archive results
        run: |
          mkdir -p reports/semgrep
          cp semgrep.* reports/semgrep/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: reports/semgrep/
          retention-days: 30

  dast_nuclei_scan:
    name: 🌐 Nuclei DAST Scan
    runs-on: ubuntu-latest
    needs: semgrep_static_analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nuclei
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          export PATH="$HOME/go/bin:$PATH"
          nuclei -version

      - name: Download Nuclei Templates
        run: nuclei -update-templates -silent

      - name: Define Target and Validate
        id: target
        run: |
          TARGET="${{ env.STAGING_URL }}"
          if [[ "$TARGET" == *"example.com"* ]] || [[ -z "$TARGET" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping DAST - invalid or placeholder URL: $TARGET"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "target=$TARGET" >> $GITHUB_OUTPUT
            echo "✅ Valid DAST target: $TARGET"
          fi

      - name: Run Nuclei Scan
        if: steps.target.outputs.skip != 'true'
        run: |
          mkdir -p reports/nuclei
          nuclei -target "${{ steps.target.outputs.target }}" \
            -templates ~/.config/nuclei/templates \
            -tags cve,vuln,misconfig,exposure \
            -severity critical,high,medium,low,info \
            -rate-limit 10 \
            -timeout 30 \
            -retries 2 \
            -jsonl -output reports/nuclei/nuclei-findings.json \
            -sarif-export reports/nuclei/nuclei-findings.sarif \
            -silent || echo "⚠️ Nuclei scan finished with warnings"

      - name: Validate and Fix SARIF if Needed
        if: steps.target.outputs.skip != 'true'
        run: |
          if [ ! -s reports/nuclei/nuclei-findings.sarif ]; then
            echo "⚠️ Creating fallback SARIF"
            mkdir -p reports/nuclei
            echo '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"nuclei"}},"results":[]}]}'> reports/nuclei/nuclei-findings.sarif
          fi

      - name: Upload SARIF to GitHub Security Tab
        if: steps.target.outputs.skip != 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/nuclei/nuclei-findings.sarif
          category: nuclei-dast

      - name: Upload Nuclei Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-report
          path: reports/nuclei/
          retention-days: 30

  intelligence_reporting:
    name: 📊 Intelligence & Clean Reporting
    runs-on: ubuntu-latest
    needs: [semgrep_static_analysis, dast_nuclei_scan]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Summarize Security Results
        run: |
          echo "📊 Generating summary..."

          total_critical=0; total_high=0; total_medium=0; total_findings=0

          if [ -f reports/semgrep-report/semgrep.json ]; then
            total_critical_semgrep=$(jq '[.results[] | select(.extra.severity=="ERROR" or .extra.severity=="CRITICAL")] | length' reports/semgrep-report/semgrep.json)
            total_high_semgrep=$(jq '[.results[] | select(.extra.severity=="WARNING" or .extra.severity=="HIGH")] | length' reports/semgrep-report/semgrep.json)
            total_medium_semgrep=$(jq '[.results[] | select(.extra.severity=="MEDIUM")] | length' reports/semgrep-report/semgrep.json)
            total_findings_semgrep=$(jq '.results | length' reports/semgrep-report/semgrep.json)
          else
            total_critical_semgrep=0; total_high_semgrep=0; total_medium_semgrep=0; total_findings_semgrep=0
          fi

          if [ -f reports/nuclei-report/nuclei-findings.json ]; then
            total_critical_nuclei=$(jq '[.[] | select(.info.severity=="critical")] | length' reports/nuclei-report/nuclei-findings.json)
            total_high_nuclei=$(jq '[.[] | select(.info.severity=="high")] | length' reports/nuclei-report/nuclei-findings.json)
            total_medium_nuclei=$(jq '[.[] | select(.info.severity=="medium")] | length' reports/nuclei-report/nuclei-findings.json)
            total_findings_nuclei=$(jq 'length' reports/nuclei-report/nuclei-findings.json)
          else
            total_critical_nuclei=0; total_high_nuclei=0; total_medium_nuclei=0; total_findings_nuclei=0
          fi

          total_critical=$((total_critical_semgrep + total_critical_nuclei))
          total_high=$((total_high_semgrep + total_high_nuclei))
          total_medium=$((total_medium_semgrep + total_medium_nuclei))
          total_findings=$((total_findings_semgrep + total_findings_nuclei))

          if [ "$total_critical" -gt 0 ]; then
            risk_level="CRITICAL"; risk_symbol="🚨"
          elif [ "$total_high" -gt 5 ]; then
            risk_level="HIGH"; risk_symbol="⚠️"
          elif [ "$total_high" -gt 0 ]; then
            risk_level="MEDIUM"; risk_symbol="🟡"
          else
            risk_level="LOW"; risk_symbol="✅"
          fi

          compliance_score=$((100 - total_critical * 10 - total_high * 3))
          [ $compliance_score -lt 0 ] && compliance_score=0

          mkdir -p reports/final

          cat > reports/final/security-report.md << 'REPORT_EOF'
          # 🔒 Security Pipeline Report

          ## RISK_SYMBOL Risk Level: RISK_LEVEL
          - **Critical Issues:** TOTAL_CRITICAL
          - **High Issues:** TOTAL_HIGH
          - **Medium Issues:** TOTAL_MEDIUM
          - **Total Findings:** TOTAL_FINDINGS
          - **Compliance Score:** COMPLIANCE_SCORE%

          ## 📊 Breakdown by Tool
          - **Semgrep (SAST):** SEMGREP_FINDINGS findings (SEMGREP_CRITICAL critical, SEMGREP_HIGH high)
          - **Nuclei (DAST):** NUCLEI_FINDINGS findings (NUCLEI_CRITICAL critical, NUCLEI_HIGH high)

          ## 🎯 Recommended Actions
          RECOMMENDED_ACTIONS

          **Report generated:** REPORT_DATE
          REPORT_EOF

          # Replace placeholders with actual values
          sed -i "s/RISK_SYMBOL/$risk_symbol/g" reports/final/security-report.md
          sed -i "s/RISK_LEVEL/$risk_level/g" reports/final/security-report.md
          sed -i "s/TOTAL_CRITICAL/$total_critical/g" reports/final/security-report.md
          sed -i "s/TOTAL_HIGH/$total_high/g" reports/final/security-report.md
          sed -i "s/TOTAL_MEDIUM/$total_medium/g" reports/final/security-report.md
          sed -i "s/TOTAL_FINDINGS/$total_findings/g" reports/final/security-report.md
          sed -i "s/COMPLIANCE_SCORE/$compliance_score/g" reports/final/security-report.md
          sed -i "s/SEMGREP_FINDINGS/$total_findings_semgrep/g" reports/final/security-report.md
          sed -i "s/SEMGREP_CRITICAL/$total_critical_semgrep/g" reports/final/security-report.md
          sed -i "s/SEMGREP_HIGH/$total_high_semgrep/g" reports/final/security-report.md
          sed -i "s/NUCLEI_FINDINGS/$total_findings_nuclei/g" reports/final/security-report.md
          sed -i "s/NUCLEI_CRITICAL/$total_critical_nuclei/g" reports/final/security-report.md
          sed -i "s/NUCLEI_HIGH/$total_high_nuclei/g" reports/final/security-report.md
          sed -i "s/REPORT_DATE/$(date -u)/g" reports/final/security-report.md

          # Generate recommendations based on findings
          if [ "$total_critical" -gt 0 ]; then
            recommendations="- 🚨 Address critical issues immediately and audit SDLC process."
          elif [ "$total_high" -gt 5 ]; then
            recommendations="- ⚠️ Review high findings within 7 days and improve testing coverage."
          elif [ "$total_high" -gt 0 ]; then
            recommendations="- 📋 Address high findings in upcoming sprint."
          else
            recommendations="- ✅ Maintain good security hygiene."
          fi

          sed -i "s|RECOMMENDED_ACTIONS|$recommendations|g" reports/final/security-report.md

          echo "✅ Security summary compiled"


      - name: Create Step Summary
        run: |
          if [ -f reports/final/security-report.md ]; then
            echo "## 🔒 Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
            cat reports/final/security-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No security summary generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: reports/final/
          retention-days: 30
